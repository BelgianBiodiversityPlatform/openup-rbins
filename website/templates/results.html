{% extends "base.html" %}

{% load querystring_tags l10n %}

{% block content %}
<h1>{{ pictures.paginator.count }} results</h1>

<h2>Active filters</h2>
<ul>
{% for filter in filters %}
  {{ filter.name }}: {{ filter.value }}
{% empty %}
    <li>All pictures are displayed.</li>
{% endfor %}
</ul>

<script id="thumbnailTpl" type="text/template">
  {# 1. Thumbnail #}
  <li class="span2">
    <a class="thumbnail" data-toggle="lightbox" data-target="#lightbox_[[ picture_id ]]">
      <img src=[[ fileuri ]] alt="" />
    </a>
  </li> 

  {# 2. Lightbox #}
  <div class="lightbox fade" id="lightbox_[[ picture_id ]]" style="display: none;">
    <div class="lightbox-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">×</button>
        <h1 class="sn">[[ scientificname ]]</h1>
      </div>

      <div id="lightbox-colleft">
        <img src="[[ fileuri_picture_only ]]" alt="" />
      </div>

      <div id="lightbox-colright">
        <h2>Taxonomy</h2>
        <table class="table table-condensed table-striped table-bordered">
          <tr><td><b>Family:</b></td><td> {{ picture.family.name|default:"/" }}</td></tr>
          <tr><td><b>Subfamily:</b></td><td> {{ picture.subfamily.name|default:"/"}}</td></tr>
          <tr><td><b>Genus:</b></td><td> {{ picture.genus.name|default:"/" }}</td></tr>
          <tr><td><b>Species:</b></td><td> {{ picture.species.name|default:"/" }}</td></tr>
          <tr><td><b>Subspecies:</b></td><td> {{ picture.subspecies.name|default:"/" }}</td></tr> 
        </table>

        <h2>Capture</h2>
        <table class="table table-condensed table-striped table-bordered">
          <tr><td><b>Date:</b></td><td> {{ picture.eventdate_verbatim|default:"/" }}</td></tr>
          <tr><td><b>Country:</b></td><td> {{ picture.country.name|default:"/" }}</td></tr>
          <tr><td><b>Province:</b></td><td> {{ picture.province.name|default:"/" }}</td></tr>
          <tr><td><b>Station:</b></td><td> {{ picture.station.name|default:"/" }}</td></tr>
        </table>

        <h2>Picture</h2>
          <table class="table table-condensed table-striped table-bordered">
          <tr><td><b>Filename:</b></td><td>{{ picture.origpathname }}</td></tr>
          <tr><td><b>View:</b></td><td> {{ picture.view.name|default:"/" }}</td></tr>    
        </table>

        <img src="{{ STATIC_URL }}img/cc-by-sa.png" style="width: 100px; margin:10px;" alt="CC BY SA license" />
        <div class="alert alert-info">Picture by <strong>Noël MAL</strong>.</div>
      </div>
    </div>
  </div>
</script>

<ul class="thumbnails" id="thumbnails_container">
</ul> 

{% comment %}
  {# TODO: implement JS-based shortcuts so they cna be used without the ALT key  #}
  {# TODO: Describe the sortcuts on the page #}
  <div class="pagination pagination-right">
    <ul>
      <li {% if not pictures.has_previous %}class="disabled"{% endif %}>
        {% if pictures.has_previous %}
          <a accesskey="<" href="{% url "website-search-view" %}?{% qs_alter request.GET page=pictures.previous_page_number %}">«</a>
        {% else %}
          <a href="javascript: void(0)">«</a>
        {% endif %}  
      </li>

      <li class="active">
        <a>Page {{ pictures.number }} of {{ pictures.paginator.num_pages }}.</a>
      </li>

      <li {% if not pictures.has_next %}class="disabled"{% endif %}>
        {% if pictures.has_next %}
          <a accesskey=">" href="{% url "website-search-view" %}?{% qs_alter request.GET page=pictures.next_page_number %}">»</a>
        {% else %}
          <a href="javascript: void(0)">»</a>
        {% endif %} 
      </li>
    </ul>
  </div>
  {% endcomment %}

  {% endblock %}

  {% block additional_js %}
  <script type="text/javascript" src="{{ STATIC_URL }}js/mustache.js"></script>

  <script type="text/javascript">
    // TODO: Move code to openup.js
    var conf = {
      'json_results_url': '{% url "ou-ajax-search-results" %}'
    };

    var currentPage;
    var filters;

    var urlParamsToObj = function(){
      var params = location.search.substring(1);
      return JSON.parse('{"' + decodeURI(params).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g,'":"') + '"}')
    }

    var resultToHtml = function(data){
      console.log(data);

      var template = $('#thumbnailTpl').html();
      var d = {
        'fileuri': data.fileuri,
        'picture_id': data.picture_id,

        'scientificname': data.scientificname,
        'fileuri_picture_only': data.fileuri_picture_only
      };

      return Mustache.to_html(template, d);
    };

    var loadJSONResults = function(page_num, filters){
      $.getJSON(conf.json_results_url, filters, function(data){
        $.each(data, function(i, result){
          // Turn each JSON object to a DOM entry
          var thumb = resultToHtml(result);
          $("#thumbnails_container").append(thumb);
        });
      });
    };

    var initPage = function(){
      currentPage = 1;
      filters = urlParamsToObj();

      // Avoid collision between Django and Mustache about curly braces
      Mustache.tags = ['[[', ']]'];

      loadJSONResults(currentPage, filters);
    };

    $(function(){
      initPage();
    });
  </script>
{% endblock %}
  