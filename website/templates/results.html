{% extends "base.html" %}

{% load querystring_tags l10n %}

{% block content %}
<h1>{{ pictures.paginator.count }} results</h1>

<h2>Active filters</h2>
<ul>
{% for filter in filters %}
  {{ filter.name }}: {{ filter.value }}
{% empty %}
    <li>All pictures are displayed.</li>
{% endfor %}
</ul>
<p>Results: <span id="results_counter"></span></p>

<script id="thumbnailTpl" type="text/template">
  {# 1. Thumbnail #}
  <li class="span2">
    <a class="thumbnail" data-toggle="lightbox" data-target="#lightbox_[[ picture_id ]]">
      <img src=[[ fileuri ]] alt="" />
    </a>
  </li> 

  {# 2. Lightbox #}
  <div class="lightbox fade" id="lightbox_[[ picture_id ]]" style="display: none;">
    <div class="lightbox-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">×</button>
        <h1 class="sn">[[ scientificname ]]</h1>
      </div>

      <div id="lightbox-colleft">
        <img src="[[ fileuri_picture_only ]]" alt="" />
      </div>

      <div id="lightbox-colright">
        <h2>Taxonomy</h2>
        <table class="table table-condensed table-striped table-bordered">
          <tr><td><b>Family:</b></td><td>[[ family_name ]]</td></tr>
          <tr><td><b>Subfamily:</b></td><td>[[ subfamily_name ]]</td></tr>
          <tr><td><b>Genus:</b></td><td>[[ genus_name ]]</td></tr>
          <tr><td><b>Species:</b></td><td> [[ species_name ]]</td></tr>
          <tr><td><b>Subspecies:</b></td><td>[[ subspecies_name ]]</td></tr> 
        </table>

        <h2>Capture</h2>
        <table class="table table-condensed table-striped table-bordered">
          <tr><td><b>Date:</b></td><td>[[ eventdate_verbatim ]]</td></tr>
          <tr><td><b>Country:</b></td><td>[[ country_name ]]</td></tr>
          <tr><td><b>Province:</b></td><td>[[ province_name ]]</td></tr>
          <tr><td><b>Station:</b></td><td>[[ station_name ]]</td></tr>
        </table>

        <h2>Picture</h2>
          <table class="table table-condensed table-striped table-bordered">
          <tr><td><b>Filename:</b></td><td>[[ origpathname ]]</td></tr>
          <tr><td><b>View:</b></td><td>[[ view_name ]]</td></tr>    
        </table>

        <img src="{{ STATIC_URL }}img/cc-by-sa.png" style="width: 100px; margin:10px;" alt="CC BY SA license" />
        <div class="alert alert-info">Picture by <strong>Noël MAL</strong>.</div>
      </div>
    </div>
  </div>
</script>

<div id="thumbnails_container">

</div>

<div id="under_thumbnails"></div>

{% endblock %}

{% block additional_js %}
  <script type="text/javascript" src="{{ STATIC_URL }}js/mustache.js"></script>

  <script type="text/javascript">
    // TODO: Move code to openup.js ?

    var OU_SEARCH = {
        currentlyAdding: false,
        finished: false,
        currentPage: 0,
        filters: null,

        conf: {
          json_results_url: '{% url "ou-ajax-search-results" %}',
          under_thumbnails_elem: $('#under_thumbnails'),
          results_counter_elem: $('#results_counter')
        }
    };

    var urlParamsToObj = function(){
      var params = location.search.substring(1);
      if (params == ""){
        return {};
      } else {
        return JSON.parse('{"' + decodeURI(params).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g,'":"') + '"}');
      }
    }

    var resultToHtml = function(data){
      //console.log(data);

      var template = $('#thumbnailTpl').html();
      var d = {
        'fileuri': data.fileuri,
        'picture_id': data.picture_id,

        'scientificname': data.scientificname,
        'fileuri_picture_only': data.fileuri_picture_only,
        'family_name': data.family_name,
        'subfamily_name': data.subfamily_name,
        'genus_name': data.genus_name,
        'species_name': data.species_name,
        'subspecies_name': data.subspecies_name,

        'eventdate_verbatim': data.eventdate_verbatim,
        'country_name': data.country_name,
        'province_name': data.province_name,
        'station_name': data.station_name,
        'origpathname': data.origpathname,
        'view_name': data.view_name
      };

      return Mustache.to_html(template, d);
    };

    var loadAndProcessJSON = function(page_num, filters){
      var p = filters;
      p.page = page_num;

      if (!OU_SEARCH.finished){
        $.getJSON(OU_SEARCH.conf.json_results_url, p, function(data){
          // Update results counter (not necessary each time, but will be useful if we make it more dynamic later).
          OU_SEARCH.conf.results_counter_elem.text(data.meta.total_count);

          $.each(data.pictures, function(i, result){
            // Arrange them in rows (ul) of 6 to respect the grid
            if (i % 6 == 0){ 
              $new_ul = $('<ul class="thumbnails"></ul>');
              $("#thumbnails_container").append($new_ul);
            }
            // Turn each JSON object to a DOM entry            
            var thumb = resultToHtml(result);
            $new_ul.append(thumb);
          });
            
          // Done, we're ready to start again...
          OU_SEARCH.currentlyAdding = false;

          if(!data.meta.has_next){
            OU_SEARCH.finished = true;
            OU_SEARCH.conf.under_thumbnails_elem.append("No more images.");
          }
        });
      }
    };

    var addThumbRows = function(num_rows){
      // "Mutex" to ensure we only fire up one "addition" at a time.
      OU_SEARCH.currentlyAdding = true;
      
      // For now, we only add one row at a time... Addinfa for loop here = bad idea (concurrency)
      OU_SEARCH.currentPage += 1;
      loadAndProcessJSON(OU_SEARCH.currentPage, OU_SEARCH.filters); 
    };

    var initPage = function(){
      // Avoid collision between Django and Mustache about curly braces
      Mustache.tags = ['[[', ']]'];

      OU_SEARCH.filters = urlParamsToObj();

      addThumbRows(OU_SEARCH.conf.rows_per_turn);

      $(window).scroll(function(){
        if(($(OU_SEARCH.conf.under_thumbnails_elem).offset().top < $(this).height() + $(this).scrollTop()) && !OU_SEARCH.currentlyAdding){
          addThumbRows(OU_SEARCH.conf.rows_per_turn);
        }
      });
    
    };

    $(function(){
      initPage();
    });
  </script>
{% endblock %}
  