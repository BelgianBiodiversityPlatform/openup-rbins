{% extends "base.html" %}

{% load querystring_tags l10n %}

{% block content %}
<h1>{{ pictures.paginator.count }} results</h1>

<h2>Active filters</h2>
<ul>
{% for filter in filters %}
  {{ filter.name }}: {{ filter.value }}
{% empty %}
    <li>All pictures are displayed.</li>
{% endfor %}
</ul>

<script id="thumbnailTpl" type="text/template">
  {# 1. Thumbnail #}
  <li class="span2">
    <a class="thumbnail" data-toggle="lightbox" data-target="#lightbox_[[ picture_id ]]">
      <img src=[[ fileuri ]] alt="" />
    </a>
  </li> 

  {# 2. Lightbox #}
  <div class="lightbox fade" id="lightbox_[[ picture_id ]]" style="display: none;">
    <div class="lightbox-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">×</button>
        <h1 class="sn">[[ scientificname ]]</h1>
      </div>

      <div id="lightbox-colleft">
        <img src="[[ fileuri_picture_only ]]" alt="" />
      </div>

      <div id="lightbox-colright">
        <h2>Taxonomy</h2>
        <table class="table table-condensed table-striped table-bordered">
          <tr><td><b>Family:</b></td><td>[[ family_name ]]</td></tr>
          <tr><td><b>Subfamily:</b></td><td>[[ subfamily_name ]]</td></tr>
          <tr><td><b>Genus:</b></td><td>[[ genus_name ]]</td></tr>
          <tr><td><b>Species:</b></td><td> [[ species_name ]]</td></tr>
          <tr><td><b>Subspecies:</b></td><td>[[ subspecies_name ]]</td></tr> 
        </table>

        <h2>Capture</h2>
        <table class="table table-condensed table-striped table-bordered">
          <tr><td><b>Date:</b></td><td>[[ eventdate_verbatim ]]</td></tr>
          <tr><td><b>Country:</b></td><td>[[ country_name ]]</td></tr>
          <tr><td><b>Province:</b></td><td>[[ province_name ]]</td></tr>
          <tr><td><b>Station:</b></td><td>[[ station_name ]]</td></tr>
        </table>

        <h2>Picture</h2>
          <table class="table table-condensed table-striped table-bordered">
          <tr><td><b>Filename:</b></td><td>[[ origpathname ]]</td></tr>
          <tr><td><b>View:</b></td><td>[[ view_name ]]</td></tr>    
        </table>

        <img src="{{ STATIC_URL }}img/cc-by-sa.png" style="width: 100px; margin:10px;" alt="CC BY SA license" />
        <div class="alert alert-info">Picture by <strong>Noël MAL</strong>.</div>
      </div>
    </div>
  </div>
</script>

<ul class="thumbnails" id="thumbnails_container">
</ul> 

{% endblock %}

{% block additional_js %}
  <script type="text/javascript" src="{{ STATIC_URL }}js/mustache.js"></script>

  <script type="text/javascript">
    // TODO: Move code to openup.js
    var conf = {
      'json_results_url': '{% url "ou-ajax-search-results" %}'
    };

    var currentPage;
    var filters;

    var urlParamsToObj = function(){
      var params = location.search.substring(1);
      return JSON.parse('{"' + decodeURI(params).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g,'":"') + '"}')
    }

    var resultToHtml = function(data){
      console.log(data);

      var template = $('#thumbnailTpl').html();
      var d = {
        'fileuri': data.fileuri,
        'picture_id': data.picture_id,

        'scientificname': data.scientificname,
        'fileuri_picture_only': data.fileuri_picture_only,
        'family_name': data.family_name,
        'subfamily_name': data.subfamily_name,
        'genus_name': data.genus_name,
        'species_name': data.species_name,
        'subspecies_name': data.subspecies_name,

        'eventdate_verbatim': data.eventdate_verbatim,
        'country_name': data.country_name,
        'province_name': data.province_name,
        'station_name': data.station_name,
        'origpathname': data.origpathname,
        'view_name': data.view_name
      };

      return Mustache.to_html(template, d);
    };

    var loadJSONResults = function(page_num, filters){
      $.getJSON(conf.json_results_url, filters, function(data){
        $.each(data, function(i, result){
          // Turn each JSON object to a DOM entry
          var thumb = resultToHtml(result);
          $("#thumbnails_container").append(thumb);
        });
      });
    };

    var initPage = function(){
      currentPage = 1;
      filters = urlParamsToObj();

      // Avoid collision between Django and Mustache about curly braces
      Mustache.tags = ['[[', ']]'];

      loadJSONResults(currentPage, filters);
    };

    $(function(){
      initPage();
    });
  </script>
{% endblock %}
  